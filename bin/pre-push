#!/bin/sh

# Run linter on all files 
yarn run lint

# Output auto-fixed files to be reviewed before code is pushed
FILES=$(
  git diff --name-only | \
    grep -E "\.jsx\$|\.js\$|\.scss\$|\.md\$"
      )

if [[ -n ${FILES} ]]
then
  echo "----- PLEASE REVIEW THE FOLLOWING AUTO-FIXED FILES -----"
  printf '%s\n' ${FILES}
  echo
  exit 1
fi

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
IS_HOTFIX=0

# Detect if the branch name starts with hotfix/
if [[ ${BRANCH_NAME} =~ hotfix/.* ]]
then
  IS_HOTFIX=1
fi

echo "Branch: ${BRANCH_NAME}"
echo "Hotfix: ${IS_HOTFIX}"

# If this is a hotfix, run Jest tests without the --coverage flag
#  to by-pass the global coverage threshold
echo "+++ Running Jest tests for added/changed files only"
if [[ $IS_HOTFIX = 1 ]]
then
  echo "Test coverage analysis is skipped for hotfix"
  yarn jest --changedSince=master
else
  echo "--coverage flag enabled"
  yarn jest --coverage --changedSince=master
fi
